#+TITLE: VPS @ GANDI

This is the config for a wireguard nginx reverse proxy @

* Install
#+begin_src bash :tangle copy-conf-vps1.sh
  #!/usr/bin/env bash
  scp ~/dotfiles/systems/servers/configuration-vps1.nix root@46.226.104.98:/etc/nixos/configuration.nix

#+end_src

* Wireguard keys

#+begin_src shell
  umask 077 # this is so to make files only readable by root
  wg genkey > /root/wg-private
  wg pubkey < /root/wg-private > /root/wg-public
#+end_src

* Configuration

#+begin_src nix :tangle configuration-vps1.nix

  { pkgs, configs, ... }:

  {
    imports = [ ./gandicloud.nix ];

    environment.systemPackages = with pkgs; [
      neovim curl htop glances neofetch
      wireguard-tools
    ];

    # Firewall 
    networking.firewall = {
      allowedTCPPorts = [ ];
      allowedUDPPorts = [ 51820 ];
    };
    # Wireguard quick
    networking.wg-quick.interfaces = {
      wg0 = {
        address = [ "192.168.100.1/24" ]; # "fdc9:281f:04d7:9ee9::1/64" 
        listenPort = 51820;
        privateKeyFile = "/root/wg-private";
        peers = [
          {
            # laptop
            publicKey = "G86mclNgIuxV+16AU60kwQI4nQhAbko0b5ehmXe3XAI=";
            presharedKeyFile = "/root/wg-preshared";
            allowedIPs = [ "192.168.100.1/24"]; # "fdc9:281f:04d7:9ee9::2/128" 
          }
          # More peers can be added here.
        ];
      };
    };

    # nginx reverse proxy
    services.nginx = {
      enable = true;
      recommendedGzipSettings = true;
      recommendedOptimisation = true;
      recommendedProxySettings = true;
      recommendedTlsSettings = true;
         virtualHosts."test.geokkjer.eu" = { default = true; enableACME = false; addSSL = false; locations."/".proxyPass = "http://192.168.1.104:80/"; };
    };

    # acme let's encrypt
    security.acme = {
      acceptTerms = true;
      email = "geokkjer@gmail.com";
    };
  }

#+end_src

* Sources

[[https://dataswamp.org/~solene/2021-05-18-nixos-wireguard.html][Wireguard-setup]]
[[https://nixos.wiki/wiki/WireGuard][Wireguard Nixos Wiki]]
